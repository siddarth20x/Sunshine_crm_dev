<div class="reminders-container">
  <div class="header">
    <h2>Reminders</h2>
  </div>

  <!-- Tabs for Today/Escalation Tasks -->
  <mat-tab-group [selectedIndex]="selectedTabIndex" (selectedTabChange)="onTabChange($event)">
    <mat-tab>
      <ng-template mat-tab-label>
        <span class="tab-label">
          Today's Tasks
          <span *ngIf="todayTaskCount > 0" class="tab-count-badge">{{todayTaskCount}}</span>
        </span>
      </ng-template>
      <ng-template matTabContent>
        <div class="filters">
          <mat-form-field>
            <mat-label>Bank</mat-label>
            <input type="text" placeholder="Search Banks" aria-label="Bank" matInput [matAutocomplete]="autoBank" [formControl]="bankControl" (click)="onBankInputClick()">
            <mat-autocomplete #autoBank="matAutocomplete" [displayWith]="displayBankName">
              <mat-option *ngFor="let bank of filteredBanks | async" [value]="bank.company_id">
                {{bank.company_name}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Task Type</mat-label>
            <input type="text" placeholder="Search Task Types" aria-label="Task Type" matInput [matAutocomplete]="autoTaskType" [formControl]="taskTypeControl" (click)="onTaskTypeInputClick()">
            <mat-autocomplete #autoTaskType="matAutocomplete" [displayWith]="displayTaskTypeName">
              <mat-option *ngFor="let type of filteredTaskTypes | async" [value]="type.task_type_id">
                {{type.task_type_name}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab *ngIf="userRole !== 'AGENT'">
      <ng-template mat-tab-label>
        <span class="tab-label">
          Escalation Tasks
          <span *ngIf="escalationTaskCount > 0" class="tab-count-badge">{{escalationTaskCount}}</span>
        </span>
      </ng-template>
      <ng-template matTabContent>
        <div class="filters">
          <mat-form-field>
            <mat-label>Bank</mat-label>
            <input type="text" placeholder="Search Banks" aria-label="Bank" matInput [matAutocomplete]="autoBank" [formControl]="bankControl" (click)="onBankInputClick()">
            <mat-autocomplete #autoBank="matAutocomplete" [displayWith]="displayBankName">
              <mat-option *ngFor="let bank of filteredBanks | async" [value]="bank.company_id">
                {{bank.company_name}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Task Type</mat-label>
            <input type="text" placeholder="Search Task Types" aria-label="Task Type" matInput [matAutocomplete]="autoTaskType" [formControl]="taskTypeControl" (click)="onTaskTypeInputClick()">
            <mat-autocomplete #autoTaskType="matAutocomplete" [displayWith]="displayTaskTypeName">
              <mat-option *ngFor="let type of filteredTaskTypes | async" [value]="type.task_type_id">
                {{type.task_type_name}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field *ngIf="userRole !== 'AGENT'">
            <mat-label>Assignee</mat-label>
            <input type="text" placeholder="Search Users" aria-label="User" matInput [matAutocomplete]="autoUser" [formControl]="assigneeControl" (click)="onAssigneeInputClick()">
            <mat-autocomplete #autoUser="matAutocomplete" [displayWith]="displayUserName">
              <mat-option *ngFor="let user of filteredUsers | async" [value]="user.user_id">
                {{user.full_name}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
      </ng-template>
    </mat-tab>
  </mat-tab-group>

  <!-- Enhanced Error Message -->
  <mat-card *ngIf="error" class="error-message-card">
    <mat-card-content>
      <div class="error-content">
        <mat-icon color="warn" style="font-size: 32px;">error_outline</mat-icon>
        <span>{{error}}</span>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="loading-spinner" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table for Today's Tasks -->
  <table mat-table [dataSource]="dataSource" class="mat-elevation-z1" *ngIf="!loading && dataSource.data.length > 0">
    <ng-container matColumnDef="slNo">
      <th mat-header-cell *matHeaderCellDef> Sl No. </th>
      <td mat-cell *matCellDef="let element"> {{element.slNo}} </td>
    </ng-container>
    <ng-container matColumnDef="accountNo">
      <th mat-header-cell *matHeaderCellDef> Account No. </th>
      <td mat-cell *matCellDef="let element"> {{element.accountNo}} </td>
    </ng-container>
    <ng-container matColumnDef="customerName">
      <th mat-header-cell *matHeaderCellDef> Customer Name </th>
      <td mat-cell *matCellDef="let element"> {{element.customerName}} </td>
    </ng-container>
    <ng-container matColumnDef="taskId">
      <th mat-header-cell *matHeaderCellDef> Task ID </th>
      <td mat-cell *matCellDef="let element"> {{element.taskId}} </td>
    </ng-container>
    <ng-container matColumnDef="taskType">
      <th mat-header-cell *matHeaderCellDef> Task Type </th>
      <td mat-cell *matCellDef="let element"> {{element.taskType}} </td>
    </ng-container>
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef> Status </th>
      <td mat-cell *matCellDef="let element"> {{element.status}} </td>
    </ng-container>
    <ng-container matColumnDef="cifId">
      <th mat-header-cell *matHeaderCellDef> CIF ID </th>
      <td mat-cell *matCellDef="let element"> {{element.cifId}} </td>
    </ng-container>
    <ng-container matColumnDef="assignee">
      <th mat-header-cell *matHeaderCellDef> Assignee </th>
      <td mat-cell *matCellDef="let element"> {{element.assignee}} </td>
    </ng-container>
    <ng-container matColumnDef="bankName">
      <th mat-header-cell *matHeaderCellDef> Bank Name </th>
      <td mat-cell *matCellDef="let element"> {{element.bankName}} </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="onTaskClick(row)" style="cursor:pointer" matTooltip="View account details"></tr>
  </table>

  <!-- Enhanced Empty State -->
  <mat-card *ngIf="!loading && tasks.length === 0 && !error" class="no-tasks-card">
    <mat-card-content>
      <div class="empty-content">
        <mat-icon color="accent" style="font-size: 32px;">inbox</mat-icon>
        <span *ngIf="selectedTabIndex === 1">No escalation task found for selected filter.</span>
        <span *ngIf="selectedTabIndex !== 1">No tasks found for the selected filters.</span>
      </div>
    </mat-card-content>
  </mat-card>
  <div class="paginator-bottom-wrapper">
    <mat-paginator [pageSize]="30" showFirstLastButtons></mat-paginator>
  </div>
</div>
